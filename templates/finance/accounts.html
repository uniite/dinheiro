{% extends "base.html" %}

{% block scripts %}
<script>
var app = angular.module("Dinheiro", ["restangular"]);

app.config(function(RestangularProvider) {
    RestangularProvider.setBaseUrl("/finance/api");
});

app.config(['$routeProvider', function($routeProvider) {
    $routeProvider.
      //when('/institutions', {templateUrl: '/static/partials/account-list.html',   controller: "InstitutionListCtrl"}).
      //when('/institutions/:id', {templateUrl: '/static/partials/account-list.html',   controller: "AccountListCtrl"}).
      when('/', {templateUrl: '/static/partials/account-list.html',   controller: "AccountListCtrl"}).
      when('/details/:id', {templateUrl: '/static/partials/account-detail.html', controller: "AccountDetailCtrl"}).
      otherwise({redirectTo: '/'});
}]);

function apiErrorHandler() {
    alert("Something broke!");
}

app.factory("Model", function (Restangular) {
    return function (name) {
        return {
            "all": Restangular.all(name).getList,
            "get": function (id) {
                return Restangular.one(name, id).get();
            }
        };
    };
});

app.factory("Accounts", function (Model) {
    return Model("accounts")
});
app.factory("Transactions", function (Model) {
    return Model("transactions")
});

app.controller("AccountListCtrl", function ($scope, Accounts) {
    Accounts.all().then(function (accounts) {
        $scope.accounts = accounts;
    }, apiErrorHandler);
});

app.controller("AccountDetailCtrl", function ($scope, $routeParams, Restangular, Accounts, Transactions) {
    Accounts.get($routeParams.id).then(function (account) {
        $scope.account = account;
    }, apiErrorHandler);
    Transactions.all().then(function (transactions) {
        for (var i=0; i < transactions.length; i++) {
            transactions[i].date = moment(transactions[i].date);
            transactions[i].formatted_date = transactions[i].date.format("dddd, MMMM Do YYYY, HH:mm A");
        }
        $scope.transactions = transactions;
    }, apiErrorHandler);
    Restangular.one("stats", "").get().then(function (stats) {
        function parseTimeSeries(data) {
            return data.map(function(point) {
                return [
                    (new Date(point.day)).getTime(),
                    parseFloat(point.total_amount)
                ];
            });
        }
        var oneDay = 24 * 3600 * 1000;
        $scope.timeChart = $("#time-chart").plot([
            /*{
                data: parseTimeSeries(stats.deposits),
                color: "rgb(30, 180, 20)"
                //threshold: { below: 0, color: "rgb(200, 20, 30)" }
            },*/ {
                data: parseTimeSeries(stats.withdrawals),
                color: "rgb(200, 20, 30)"
            }
        ],
        {
            bars: {
                barWidth: oneDay * 0.6,
                show: true
            },
            xaxis: {
                mode: "time"
            }
        });
    });
});
</script>
{% endblock %}

{% block content %}
{% verbatim %}
    <div ng-view></div>
{% endverbatim %}
{% endblock %}
