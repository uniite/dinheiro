{% extends "base.html" %}

{% block scripts %}
<script>

$(function() {
    // Make the Accounts tab the highlighted tab
    $("li.active").removeClass("active");
    $("li#accounts-tab").addClass("active");
});

var app = angular.module("Dinheiro", ["restangular"]);

app.config(function(RestangularProvider) {
    RestangularProvider.setBaseUrl("/finance/api");
});

app.config(['$routeProvider', function($routeProvider) {
    $routeProvider.
      //when('/institutions', {templateUrl: '/static/partials/account-list.html',   controller: "InstitutionListCtrl"}).
      //when('/institutions/:id', {templateUrl: '/static/partials/account-list.html',   controller: "AccountListCtrl"}).
      when('/', {templateUrl: '/static/partials/account-list.html',   controller: "AccountListCtrl"}).
      when('/details/:id', {templateUrl: '/static/partials/account-detail.html', controller: "AccountDetailCtrl"}).
      otherwise({redirectTo: '/'});
}]);

function apiErrorHandler() {
    alert("Something broke!");
}

app.factory("Model", function (Restangular) {
    return function (name) {
        return {
            "all": Restangular.all(name).getList,
            "get": function (id) {
                return Restangular.one(name, id).get();
            },
            "one": function(id) {
                return Restangular.one(name, id);
            }
        };
    };
});

app.factory("Accounts", function (Model) {
    return Model("accounts")
});
app.factory("Categories", function (Model) {
    return Model("categories")
});
app.factory("Transactions", function (Model) {
    return Model("transactions")
});

app.controller("AccountListCtrl", function ($scope, Accounts) {
    Accounts.all().then(function (accounts) {
        $scope.accounts = accounts;
    }, apiErrorHandler);
});

app.controller("AccountDetailCtrl", function ($scope, $routeParams, Restangular, Accounts, Categories) {
    var account_id = $routeParams.id;
    $scope.sort_field = "-date";
    // Load the account's details
    Accounts.get(account_id).then(function (account) {
        $scope.account = account;
    }, apiErrorHandler);
    $scope.categories = []; //{id: null, name: "(none)"}];
    $scope.category = null;
    $scope.transactions = [];
    $scope.addTransactions = function(transactions) {
        for (var i=0; i < transactions.length; i++) {
            transactions[i].date = moment(transactions[i].date);
            transactions[i].formatted_date = transactions[i].date.format("dddd, MMMM Do YYYY, HH:mm A");
            $scope.transactions.push(transactions[i]);
        }
        //$scope.transactions = transactions;
    };
    // Load transaction list
    Accounts.one(account_id).getList("transactions").then($scope.addTransactions, apiErrorHandler);
    // Render the transaction time-chart
    Restangular.one("stats", "").get({account: account_id}).then(function (stats) {
        function parseTimeSeries(data) {
            return data.map(function(point) {
                return [
                    (new Date(point.day)).getTime(),
                    parseFloat(point.total_amount)
                ];
            });
        }
        var oneDay = 24 * 3600 * 1000;
        $scope.timeChart = $("#time-chart").plot([
            /*{
                data: parseTimeSeries(stats.deposits),
                color: "rgb(30, 180, 20)"
                //threshold: { below: 0, color: "rgb(200, 20, 30)" }
            }, */{
                data: parseTimeSeries(stats.withdrawals),
                color: "rgb(200, 20, 30)"
            }
        ],
        {
            bars: {
                barWidth: oneDay * 0.6,
                show: true
            },
            xaxis: {
                mode: "time"
            }
        });
    }, apiErrorHandler);
    // Load categories
    Categories.all().then(function(categories) {
        for (var i = 0; i < categories.length; i++) {
            $scope.categories.push(categories[i]);
        }
    });
    // Category filter function (used on transaction list/table)
    $scope.categoryFilter = function(transaction) {
        // No category filter
        if ($scope.category === null) {
            return true;
        // Must match selected category
        } else {
            return transaction.category == $scope.category.id;
        }
    }
    // Cleans off the garbage Restangular adds to our responses
    $scope.cleanResponse = function(response) {
        var result = [];
        for (var i = 0; i < response.length; i++) {
            result.push(response[i]);
        }
        return result;
    };
    // Setup click events
    // Sync: Synchronizes the account's transactions with the financial institution's data
    $scope.sync = function(account, event) {
        if (!$scope.account) return;
        // Disable the button while the sync runs
        var button = $(event.target)
        button.addClass("disabled").text("Syncing...");
        var enableButton = function() {
            button.removeClass("disabled").text("Sync");
        };
        $scope.account.post("sync").then(function(update) {
            //new_transactions = $scope.cleanResponse(new_transactions);
            // This seems to be a fast way to extend the array (source: http://jsperf.com/angulararrays)
            //$scope.transactions = $scope.transactions.concat(new_transactions);
            $scope.account.balance = update.balance;
            $scope.addTransactions(update.transactions);
            enableButton();
        }, function(error) {
            enableButton();
            apiErrorHandler(error);
        });
    };
});
</script>
{% endblock %}

{% block content %}
{% verbatim %}
    <div ng-view></div>
{% endverbatim %}
{% endblock %}
