{% extends "base.html" %}

{% block scripts %}
<script>

$(function() {
    // Make the Accounts tab the highlighted tab
    $("li.active").removeClass("active");
    $("li#accounts-tab").addClass("active");
});

var app = angular.module("Dinheiro", ["restangular"]);

app.config(function(RestangularProvider) {
    RestangularProvider.setBaseUrl("/finance/api");
});

app.config(['$routeProvider', function($routeProvider) {
    $routeProvider.
      //when('/institutions', {templateUrl: '/static/partials/account-list.html',   controller: "InstitutionListCtrl"}).
      //when('/institutions/:id', {templateUrl: '/static/partials/account-list.html',   controller: "AccountListCtrl"}).
      when('/', {templateUrl: '/static/partials/account-list.html',   controller: "AccountListCtrl"}).
      when('/accounts/:id', {templateUrl: '/static/partials/account-detail.html', controller: "AccountDetailCtrl"}).
      when('/categories/:id/edit', {templateUrl: '/static/partials/category-edit.html', controller: "TransactionEditCtrl"}).
      otherwise({redirectTo: '/'});
}]);

function apiErrorHandler() {
    alert("Something broke!");
}

app.factory("Model", function (Restangular) {
    return function (name) {
        return {
            "all": Restangular.all(name).getList,
            "get": function (id) {
                return Restangular.one(name, id).get();
            },
            "name": name,
            "one": function(id) {
                return Restangular.one(name, id);
            }
        };
    };
});

app.factory("Accounts", function (Model) {
    return Model("accounts")
});
app.factory("Categories", function (Model) {
    return Model("categories")
});
app.factory("Transactions", function (Model) {
    return Model("transactions")
});

app.service("modelCache", function($rootScope, Accounts, Categories, Transactions) {
    var cache = {};
    var index = {};

    // It is important to push new items to our cache arrays so we don't break any bindings
    // (rather than just replacing them in the cache object)
    function addItems(model_name, items) {
        // Add them to the cache
        for (var i = 0; i < items.length; i++) {
            cache[model_name].push(items[i]);
            // Also add them to the index, just by ID for now
            index[model_name].byID[items[i].id] = items[i];
        }
    }

    function initModel(model) {
        cache[model.name] = cache[model.name] || [];
        index[model.name] = index[model.name] || { byID: {} };
    }

    // These should be automatically generated eventually
    return {
        loadModel: function(model) {
            initModel(model);
            model.all().then(function (items) {
                addItems(model.name, items);
            }, apiErrorHandler);
        },
        loadCustom: function(model, items) {
            initModel(model);
            addItems(model.name, items);
            console.log(_.string.sprintf("Loaded %d items", items.length));
        },
        getCached: function(model) {
            initModel(model);
            return cache[model.name];
        },
        findByID: function(model, id) {
            return index[model.name].byID[id];
        }
    }
});

app.controller("AccountListCtrl", function ($scope, modelCache) {
    modelCache.loadModel(Accounts);
    $scope.accounts = modelCache.getCached(Accounts);
});

app.controller("AccountDetailCtrl", function ($scope, $routeParams, Restangular, Accounts, Categories, Transactions, modelCache) {
    var account_id = $routeParams.id;
    $scope.sort_field = "-date";

    $scope.accounts = modelCache.getCached(Accounts);
    if (!$scope.accounts) {
        modelCache.loadModel(Accounts);
    }
    $scope.account = modelCache.findByID(Accounts, account_id);

    modelCache.loadModel(Categories);
    $scope.categories = modelCache.getCached(Categories);

    // Transaction loading
    Accounts.one(account_id).getList("transactions").then(function(transactions) {
        modelCache.loadCustom(Transactions, transactions.map(function(t) {
            t.date = moment(t.date);
            t.formatted_date = t.date.format("dddd, MMMM Do YYYY, HH:mm A");
            var category_id = t.category;
            t.category = function() {
                var default_category = {name: "none"};

                if (!$scope.categories) {
                    console.warn("FAIL");
                    return default_category;
                }

                var matches = $scope.categories.filter(function(c) {
                    return c.id == category_id;
                });


                if (matches.length == 0)
                    return default_category;

                console.log(matches[0]);
                return matches[0];
            }
            return t;
        }));
    }, apiErrorHandler);
    $scope.transactions = modelCache.getCached(Transactions);

    $scope.category = null;

    // Render the transaction time-chart
    Restangular.one("stats", "").get({account: account_id}).then(function (stats) {
        function parseTimeSeries(data) {
            return data.map(function(point) {
                return [
                    (new Date(point.day)).getTime(),
                    parseFloat(point.total_amount)
                ];
            });
        }
        var oneDay = 24 * 3600 * 1000;
        $scope.timeChart = $("#time-chart").plot([
            /*{
                data: parseTimeSeries(stats.deposits),
                color: "rgb(30, 180, 20)"
                //threshold: { below: 0, color: "rgb(200, 20, 30)" }
            }, */{
                data: parseTimeSeries(stats.withdrawals),
                color: "rgb(200, 20, 30)"
            }
        ],
        {
            bars: {
                barWidth: oneDay * 0.6,
                show: true
            },
            xaxis: {
                mode: "time"
            }
        });
    }, apiErrorHandler);
    // Load categories
    /*$scope.categoriesPromise = Categories.all();
    $scope.categoriesPromise.then(function(categories) {
        for (var i = 0; i < categories.length; i++) {
            $scope.categories.push(categories[i]);
            $scope.categories_by_id[categories[i].id] = categories[i];
        }
    });*/
    // Category filter function (used on transaction list/table)
    $scope.categoryFilter = function(transaction) {
        // No category filter
        if ($scope.category === null) {
            return true;
        // Must match selected category
        } else {
            return transaction.category == $scope.category.id;
        }
    }
    // Cleans off the garbage Restangular adds to our responses
    $scope.cleanResponse = function(response) {
        var result = [];
        for (var i = 0; i < response.length; i++) {
            result.push(response[i]);
        }
        return result;
    };
    // Setup click events
    // Sync: Synchronizes the account's transactions with the financial institution's data
    $scope.sync = function(account, event) {
        if (!$scope.account) return;
        // Disable the button while the sync runs
        var button = $(event.target)
        button.addClass("disabled").text("Syncing...");
        var enableButton = function() {
            button.removeClass("disabled").text("Sync");
        };
        $scope.account.post("sync").then(function(update) {
            //new_transactions = $scope.cleanResponse(new_transactions);
            // This seems to be a fast way to extend the array (source: http://jsperf.com/angulararrays)
            //$scope.transactions = $scope.transactions.concat(new_transactions);
            $scope.account.balance = update.balance;
            $scope.addTransactions(update.transactions);
            enableButton();
        }, function(error) {
            enableButton();
            apiErrorHandler(error);
        });
    };
});

app.controller("TransactionEditCtrl", function ($scope, $routeParams, Accounts, Categories) {

});
</script>
{% endblock %}

{% block content %}
{% verbatim %}
    <div ng-view></div>
{% endverbatim %}
{% endblock %}
